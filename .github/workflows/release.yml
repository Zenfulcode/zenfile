name: Release Build

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  GO_VERSION: "1.24"
  NODE_VERSION: "20"

jobs:
  update-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release version
        id: get-version
        run: |
          VERSION=${GITHUB_REF_NAME}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Update wails.json version
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          # Update the productVersion in wails.json
          sed -i "s/\"productVersion\": \".*\"/\"productVersion\": \"$VERSION\"/" wails.json
          cat wails.json

      - name: Upload updated wails.json
        uses: actions/upload-artifact@v4
        with:
          name: wails-config
          path: wails.json

  build-macos:
    needs: update-version
    runs-on: macos-latest
    strategy:
      matrix:
        platform:
          - arch: amd64
            name: macos-amd64
          - arch: arm64
            name: macos-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download updated wails.json
        uses: actions/download-artifact@v4
        with:
          name: wails-config
          path: .

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          bun install

      - name: Build macOS app
        env:
          GOARCH: ${{ matrix.platform.arch }}
        run: |
          wails build -platform darwin/${{ matrix.platform.arch }} -o zenfile

      # Code Signing
      - name: Import Code Signing Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          echo "$MACOS_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$MACOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Sign the app
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          # Sign all binaries and frameworks inside the app bundle
          find build/bin/Zenfile.app -type f \( -name "*.dylib" -o -name "*.framework" -o -perm +111 \) -exec codesign --force --options runtime --sign "$MACOS_SIGNING_IDENTITY" --timestamp {} \;

          # Sign the main app bundle
          codesign --force --options runtime --sign "$MACOS_SIGNING_IDENTITY" --timestamp --deep build/bin/Zenfile.app

          # Verify the signature
          codesign --verify --deep --strict --verbose=2 build/bin/Zenfile.app

      # Notarization
      - name: Notarize the app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create a ZIP for notarization
          cd build/bin
          ditto -c -k --keepParent Zenfile.app Zenfile-notarize.zip

          # Submit for notarization
          xcrun notarytool submit Zenfile-notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket to the app
          xcrun stapler staple Zenfile.app

          # Verify notarization
          spctl --assess --type exec -vv Zenfile.app

          # Clean up notarization zip
          rm Zenfile-notarize.zip

      # Create DMG with appdmg
      - name: Install appdmg
        run: npm install -g appdmg

      - name: Create DMG
        run: |
          cd build/bin/darwin
          appdmg appdmg.json Zenfile-${{ matrix.platform.name }}-${{ needs.update-version.outputs.version }}.dmg

      - name: Sign the DMG
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp build/bin/Zenfile-${{ matrix.platform.name }}-${{ needs.update-version.outputs.version }}.dmg

      - name: Notarize the DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit build/bin/Zenfile-${{ matrix.platform.name }}-${{ needs.update-version.outputs.version }}.dmg \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          xcrun stapler staple build/bin/Zenfile-${{ matrix.platform.name }}-${{ needs.update-version.outputs.version }}.dmg

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: Zenfile-${{ matrix.platform.name }}
          path: build/bin/Zenfile-${{ matrix.platform.name }}-${{ needs.update-version.outputs.version }}.dmg

  upload-release-assets:
    needs: [update-version, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: Zenfile-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
